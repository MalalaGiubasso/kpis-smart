<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Horas - Pase a Producción</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuración para usar la fuente Inter -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* Estilos personalizados para asegurar el uso de la fuente Inter */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7; /* Fondo suave */
        }
        /* Clase para las tarjetas de información */
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-xl */
            padding: 1.5rem;
            transition: transform 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
        }
        /* Estilo para los elementos de la lista de razones (cambio de bullet a ícono) */
        .reason-item {
            display: flex;
            align-items: flex-start;
            padding: 0.75rem;
            border-radius: 0.5rem;
            background-color: #f0f4ff; /* Indigo 50 */
            transition: background-color 0.2s;
        }
        .reason-item:hover {
            background-color: #e5ebff;
        }
    </style>
    <!-- Carga de Chart.js para visualización de datos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Título del Dashboard -->
        <header class="mb-8">
            <h1 class="text-4xl font-extrabold text-indigo-700 mb-2">
                Dashboard de Horas
            </h1>
            <p class="text-xl text-gray-600">
                Análisis de Horas Consumidas en el Último Pase a Producción
            </p>
        </header>

        <!-- Contenedor Principal de Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">

            <!-- Card 1: Total de Horas por Colaborador -->
            <div class="lg:col-span-2 card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
                    Total de Horas Trabajadas (Resumen)
                </h2>
                <div class="relative h-96">
                    <canvas id="totalHoursChart"></canvas>
                </div>
            </div>

            <!-- Card 2: Resumen Cualitativo (Razones) -->
            <div class="lg:col-span-1 card">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
                    Razones de Tardanaza (Puntos de Análisis)
                </h2>
                <div id="reasonsList" class="space-y-3 h-96 overflow-y-auto p-1">
                    <!-- Las razones se insertarán aquí con JavaScript -->
                    <p class="text-gray-500 italic">Cargando razones...</p>
                </div>
            </div>
        </div>

        <!-- Tabla de Desglose Detallado -->
        <div class="card mb-8">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">
                Desglose Detallado de Horas por Día
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-indigo-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-indigo-700 uppercase tracking-wider">
                                Colaborador
                            </th>
                            <th id="headerDay1" scope="col" class="px-6 py-3 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">
                                Día 1
                            </th>
                            <th id="headerDay2" scope="col" class="px-6 py-3 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">
                                Día 2
                            </th>
                            <th id="headerDay3" scope="col" class="px-6 py-3 text-right text-xs font-medium text-indigo-700 uppercase tracking-wider">
                                Día 3
                            </th>
                            <th scope="col" class="px-6 py-3 text-right text-xs font-extrabold text-indigo-900 uppercase tracking-wider">
                                Total
                            </th>
                        </tr>
                    </thead>
                    <tbody id="hoursTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Las filas de la tabla se insertarán aquí con JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // Datos CSV proporcionados por el usuario
        const csvData = `COLABORADOR,viernes 17/10,Sabado 18/10,domingo 19/10,Total,,RAZONES DE TARDANZA EN EL PASE
GIUBASSO JIMENEZ MARIANGELA FRANCHESCA,8,10,5.5,23.5,,TIEMPOS CORTOS DE MIGRACIÓN
LINARES VIÑA ALEXANDRA,12,21,13.5,46.5,,"CURVA DE APRENDIZAJE (BD, NUEVA INFRA)"
HERRERA CALERO CARLOS DANIEL,12,21,14,47,,FALLOS EN PRUEBAS DE DESARROLLO
YZQUIERDO TAPIA KEVIN ALEXANDER,10,17,15,42,,LO METICULOSO QUE TENIAMOS QUE SER CON LAS PRUEBAS DE QA
QUISPE APON OMAR GABRIEL ANDRE,9,16,16,41,,LAS NUEVAS FUNCIONALIDADES DE MARCAS Y TAREO
TAPARA ALDANA ROBERTO ARMANDO,10,18.5,13,41.5,,FALLOS POR FALTA DE DESCANSO DE COLABORADORES
VILLAVICENCIO RAMOS DANIEL EDUARDO,11.5,15.5,12.2,39.2,,LAS PRUEBAS CON 10 USUARIOS NO ES IGUAL QUE PRODUCCIÓN
CARRASCO CUNYA ANTONY STHIF,10,11,15.5,36.5,,"CASOS NO CONTEMPLADOS AL DESACOPLAR MÓDULOS (SOLICITUDES-TAREO, HISTÓRICOS,VALIDACIONES DE MARCACIONES CON TAREO)"
JULCA GONZALES JULIO CÉSAR,10,16,15.5,41.5,,"ENTRENAMIENTO DE SERVIDESK A CELY Y ROSA PARA LAS MESAS ÁGILES (CAMBIOS DE COMPENSACIÓN POR EXTRA, ETC)"
PADILLA AVALOS DIOGO ARMANDO,10,0,8,18,,APOYO A RRHH CON CIERRES Y DUDAS DE LOS COLABORADORES
CONDORI CONDORI ROXANA,11,13.5,6.2,30.7,,
REVILLA OCHOA JEISOM JAVIER,0,4,1.5,5.5,,
,,,,,,\n,,,,,,\nACTIVIDADES PASE,HORAS IDEALES,,,,,\n"Pase Front, Back y BD",5,,,,,\nPruebas post producción,10,,,,,\nLimpieza de datos QA (snapshot BD),1,,,,`;

        // Colores y utilidades para Chart.js
        const CHART_COLOR_PRIMARY = 'rgba(79, 70, 229, 0.8)'; // Indigo 500
        const CHART_COLOR_HOVER = 'rgba(79, 70, 229, 1)';
        
        // Colores para el desglose (días)
        const DAY_COLORS = [
            'rgba(34, 197, 94, 0.8)',  // Esmeralda 500
            'rgba(245, 158, 11, 0.8)', // Ámbar 500
            'rgba(239, 68, 68, 0.8)',  // Rojo 500
        ];
        
        /**
         * Parsea la cadena CSV y extrae los datos de los colaboradores.
         * @param {string} csv - La cadena de datos CSV.
         * @returns {{headers: string[], data: object[]}} Objeto con encabezados y datos limpios.
         */
        function parseCSV(csv) {
            // Dividir por líneas y manejar el problema de las comillas en los datos
            const lines = csv.split('\n').filter(line => line.trim().length > 0);
            
            // La primera línea son los encabezados
            const headerLine = lines[0];
            
            // Función simple para dividir la línea respetando las comillas
            const splitLine = (line) => {
                // Regex para dividir por coma, pero ignorar las comas dentro de comillas dobles
                const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g);
                // Si la línea es solo comas (líneas vacías), match devuelve null. En ese caso, devolvemos un array vacío.
                return parts ? parts.map(p => p.replace(/^"|"$/g, '').trim()) : [];
            };

            const headers = splitLine(headerLine);
            const data = [];

            // Iterar sobre las líneas de datos (a partir de la segunda línea)
            for (let i = 1; i < lines.length; i++) {
                const values = splitLine(lines[i]);
                
                // Si la primera columna está vacía, asumimos que es una fila de resumen/pie de página y paramos.
                if (!values[0] || values[0].toUpperCase() === 'ACTIVIDADES PASE') {
                    break;
                }

                // Se requiere al menos el colaborador (values[0]) y las 4 columnas de horas.
                if (values[0] && values.length >= 5) {
                    const row = {
                        colaborador: values[0],
                        // Los índices de Días y Total (1 a 4) son consistentes en la estructura del CSV
                        day1: parseFloat(values[1]) || 0,
                        day2: parseFloat(values[2]) || 0,
                        day3: parseFloat(values[3]) || 0,
                        total: parseFloat(values[4]) || 0,
                        // La razón es el índice 6 si existe, si no, es 'N/A'
                        razon: values[6] || 'N/A' 
                    };
                    data.push(row);
                }
            }

            // Los encabezados útiles para la tabla son Day 1, Day 2, Day 3 y Total
            const dayHeaders = headers.slice(1, 4);

            return { headers: dayHeaders, data: data };
        }

        /**
         * Renderiza el gráfico de barras del total de horas.
         * @param {object[]} data - Datos de los colaboradores.
         * @param {string[]} labels - Nombres de los colaboradores.
         */
        function renderTotalHoursChart(data, labels) {
            const ctx = document.getElementById('totalHoursChart').getContext('2d');
            
            // Extraer los totales
            const totals = data.map(item => item.total);

            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total de Horas Trabajadas',
                        data: totals,
                        backgroundColor: CHART_COLOR_PRIMARY,
                        borderColor: CHART_COLOR_HOVER,
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y', // Convertir a barras horizontales
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.parsed.x + ' horas';
                                }
                            }
                        },
                        title: {
                            display: true,
                            text: 'Total de Horas Consumidas por Colaborador',
                            font: { size: 16 }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Horas',
                                font: { weight: 'bold' }
                            },
                            beginAtZero: true
                        },
                        y: {
                            ticks: {
                                autoSkip: false,
                            },
                        }
                    }
                }
            });
        }

        /**
         * Renderiza la tabla de desglose de horas diarias.
         * @param {object[]} data - Datos de los colaboradores.
         * @param {string[]} dayHeaders - Encabezados de los días.
         */
        function renderHoursTable(data, dayHeaders) {
            const tableBody = document.getElementById('hoursTableBody');
            const [header1, header2, header3] = dayHeaders;

            // Actualizar encabezados de días
            document.getElementById('headerDay1').textContent = header1;
            document.getElementById('headerDay2').textContent = header2;
            document.getElementById('headerDay3').textContent = header3;

            tableBody.innerHTML = ''; // Limpiar contenido previo

            data.forEach((row, index) => {
                const tr = document.createElement('tr');
                // Estilo de fila alternado para mejor legibilidad
                tr.className = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${row.colaborador}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                        ${row.day1.toFixed(1)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                        ${row.day2.toFixed(1)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">
                        ${row.day3.toFixed(1)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-extrabold text-indigo-700 text-right">
                        ${row.total.toFixed(1)}
                    </td>
                `;
                tableBody.appendChild(tr);
            });
        }

        /**
         * Renderiza la lista de razones de tardanza (temas clave) de forma independiente.
         */
        function renderReasonsList() {
            const reasonsListContainer = document.getElementById('reasonsList');
            reasonsListContainer.innerHTML = ''; // Limpiar contenido previo

            // Lista explícita de razones proporcionada por el usuario
            const hardcodedReasons = [
                "TIEMPOS CORTOS DE MIGRACIÓN",
                "CURVA DE APRENDIZAJE (BD, NUEVA INFRA)",
                "FALLOS EN PRUEBAS DE DESARROLLO",
                "LO METICULOSO QUE TENIAMOS QUE SER CON LAS PRUEBAS DE QA",
                "LAS NUEVAS FUNCIONALIDADES DE MARCAS Y TAREO",
                "FALLOS POR FALTA DE DESCANSO DE COLABORADORES",
                "LAS PRUEBAS CON 10 USUARIOS NO ES IGUAL QUE PRODUCCIÓN",
                "CASOS NO CONTEMPLADOS AL DESACOPLAR MÓDULOS (SOLICITUDES-TAREO, HISTÓRICOS,VALIDACIONES DE MARCACIONES CON TAREO)",
                "ENTRENAMIENTO DE SERVIDESK A CELY Y ROSA PARA LAS MESAS ÁGILES (CAMBIOS DE COMPENSACIÓN POR EXTRA, ETC)",
                "APOYO A RRHH CON CIERRES Y DUDAS DE LOS COLABORADORES"
            ];
            
            if (hardcodedReasons.length === 0) {
                reasonsListContainer.innerHTML = '<p class="text-gray-500 italic p-4 text-center">No hay puntos de análisis cualitativo definidos.</p>';
                return;
            }
            
            const divList = document.createElement('div');
            divList.className = 'space-y-2';

            hardcodedReasons.forEach(reason => {
                // Crear el elemento de tarjeta/razón
                const reasonElement = document.createElement('div');
                reasonElement.className = 'reason-item'; // Clase de estilo customizado

                // Icono (un simple checkmark/bullet)
                const iconSvg = `
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-indigo-500 mr-2 flex-shrink-0 mt-0.5" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/>
                        <path d="M9 12l2 2 4-4"/>
                    </svg>
                `;
                
                reasonElement.innerHTML = `
                    ${iconSvg}
                    <p class="text-sm text-gray-700">${reason}</p>
                `;
                divList.appendChild(reasonElement);
            });

            reasonsListContainer.appendChild(divList);
        }


        // Función principal para ejecutar al cargar la página
        function initializeDashboard() {
            try {
                const { headers, data } = parseCSV(csvData);
                
                if (data.length === 0) {
                    console.error("No se pudieron parsear datos de colaboradores.");
                    document.getElementById('reasonsList').innerHTML = '<p class="text-red-500 font-semibold p-4 text-center">Error al cargar: No se encontraron datos de colaboradores válidos.</p>';
                    return;
                }

                const collaboratorLabels = data.map(item => item.colaborador);
                
                // 1. Renderizar Gráfico de Total de Horas
                renderTotalHoursChart(data, collaboratorLabels);

                // 2. Renderizar Tabla Detallada
                renderHoursTable(data, headers);

                // 3. Renderizar Lista de Razones (Ahora totalmente independiente del CSV)
                renderReasonsList();

            } catch (error) {
                console.error("Error al inicializar el dashboard:", error);
                document.getElementById('reasonsList').innerHTML = '<p class="text-red-500 font-semibold p-4 text-center">Ocurrió un error al procesar los datos. Por favor, revisa el formato CSV.</p>';
            }
        }

        // Ejecutar la inicialización cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', initializeDashboard);
    </script>
</body>
</html>

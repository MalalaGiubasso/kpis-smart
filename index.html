<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Horas de Pase a Producción</title>
    <!-- Carga de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Carga de Chart.js para gráficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        /* Personalización de la fuente y estilos base */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .card {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
            border-radius: 0.75rem; /* rounded-xl */
        }
        /* Estilos específicos para la tabla */
        .table-header {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            padding: 0.75rem 0.5rem; /* Reducido para más columnas */
            text-align: center;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem; /* Reducido para más columnas */
            line-height: 1.25rem;
        }
        .table-data {
            padding: 0.5rem 0.5rem;
            white-space: nowrap;
            text-align: center;
            font-size: 0.875rem;
        }
        .total-row {
            background-color: #e0f2fe; /* blue-100 */
            font-weight: bold;
        }
        .deviation-row {
            background-color: #fef3c7; /* yellow-100 */
            font-weight: bold;
            color: #b45309; /* amber-800 */
        }
        /* Clase para la columna final de TOTAL */
        .final-total {
            background-color: #bae6fd; /* light blue for emphasis */
            color: #0369a1; /* strong blue text */
            font-weight: 900;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-6 text-center">
            Dashboard de Horas - Pase a Producción SMART
        </h1>
        <p class="text-center text-gray-600 mb-8">
            Análisis de horas registradas, desviación y cálculos de compensación.
        </p>

        <!-- Contenedor de Gráficos -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
            
            <!-- Gráfico 1: Horas Totales Registradas -->
            <div class="card bg-white p-4">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Horas Totales Registradas por Colaborador</h2>
                <canvas id="totalHoursChart"></canvas>
            </div>

            <!-- Gráfico 2: Desviación de Horas (Adicionales/Faltantes) -->
            <div class="card bg-white p-4">
                <h2 class="text-xl font-semibold text-gray-700 mb-4">Horas Adicionales vs. Planeadas</h2>
                <canvas id="additionalHoursChart"></canvas>
            </div>

        </div>
        
        <!-- Tabla de Detalle por Día (Sin cambios en esta tabla, solo en la de Resumen) -->
        <div class="card bg-white overflow-hidden mb-8">
            <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Horas Registradas Detalladas por Día</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="table-header rounded-tl-xl">Colaborador</th>
                            <th class="table-header">viernes 17/10</th>
                            <th class="table-header">Sábado 18/10</th>
                            <th class="table-header">Domingo 19/10</th>
                            <th class="table-header rounded-tr-xl">Total Registrado</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200" id="dailyTableBody">
                        <!-- Filas de datos por día se insertarán aquí -->
                    </tbody>
                    <tfoot id="dailyTableFooter">
                        <!-- Fila de totales se insertará aquí -->
                    </tfoot>
                </table>
            </div>
        </div>


        <!-- Tabla de Resumen (Desviación y Compensación) -->
        <div class="card bg-white overflow-hidden mb-8">
            <h2 class="text-xl font-semibold text-gray-700 p-4 border-b">Resumen y Cálculo de Compensación de Horas</h2>
            <div class="overflow-x-auto">
                <table id="dataTable" class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="table-header rounded-tl-xl w-3/12">Colaborador</th>
                            <th class="table-header w-1/12">Horas Registradas</th>
                            <th class="table-header w-1/12">Horas Planeadas</th>
                            <th class="table-header w-1/12">Excedente</th>
                            <th class="table-header w-1/12">70%</th>
                            <th class="table-header w-1/12">H. EXTRAS (Propuesta)</th>
                            <th class="table-header w-2/12">COMPENSACIÓN (Propuesta)</th>
                            <th class="table-header rounded-tr-xl w-2/12">TOTAL (Propuesta)</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-200" id="summaryTableBody">
                        <!-- Filas de resumen se insertarán aquí -->
                    </tbody>
                     <tfoot id="summaryTableFooter">
                        <!-- Fila de totales de resumen se insertará aquí -->
                    </tfoot>
                </table>
            </div>
        </div>
        
        <!-- Cuadro de Razones de Tardanzas / Desviación -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="card bg-white p-6 lg:col-span-3">
                <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Razones Comunes de Desviación (Tardanzas en el Pase)
                </h2>
                <div class="text-gray-600 space-y-3">
                    <p class="font-medium text-sm">Esta sección requiere información cualitativa, no disponible en el CSV. Se puede completar manualmente o con una fuente de datos adicional.</p>
                    <ul class="list-disc list-inside ml-4 text-sm text-gray-700">
                        <li>Fallas inesperadas en la base de datos (BD).</li>
                        <li>Retrasos en la aprobación de QA/Seguridad.</li>
                        <li>Problemas de comunicación entre equipos.</li>
                        <li>Complejidad no prevista en la limpieza de datos.</li>
                        <li>Dependencias externas no resueltas a tiempo.</li>
                    </ul>
                </div>
            </div>
        </div>

    </div>

    <script>
        // Contenido del archivo CSV para el análisis
        // NOTA: Se ha añadido una columna vacía al final de la primera sección para mantener la consistencia del parseo.
        const csvData = `COLABORADOR,viernes 17/10,Sabado 18/10,domingo 19/10,Total,,,
GIUBASSO JIMENEZ MARIANGELA FRANCHESCA,8,10,5.5,23.5,,,
LINARES VIÑA ALEXANDRA,12,21,13.5,46.5,,,
HERRERA CALERO CARLOS DANIEL,12,21,14,47,,,
YZQUIERDO TAPIA KEVIN ALEXANDER,10,17,15,42,,,
QUISPE APON OMAR GABRIEL ANDRE,9,16,16,41,,,
TAPARA ALDANA ROBERTO ARMANDO,10,18.5,13,41.5,,,
VILLAVICENCIO RAMOS DANIEL EDUARDO,11.5,15.5,12.2,39.2,,,
CARRASCO CUNYA ANTONY STHIF,10,11,15.5,36.5,,,
JULCA GONZALES JULIO CÉSAR,10,16,15.5,41.5,,,
PADILLA AVALOS DIOGO ARMANDO,10,0,8,18,,,
CONDORI CONDORI ROXANA,11,13.5,6.2,30.7,,,
REVILLA OCHOA JEISOM JAVIER,0,4,1.5,5.5,,,
,,,,,,,
Horas planificadas,,,,,,,
ACTIVIDADES PASE,HORAS IDEALES,,,,,,
"Pase Front, Back y BD",5,,,,,
Pruebas post producción,10,,,,,
Limpieza de datos QA (snapshot BD),1,,,,,
Total,16,,,,,
,,,,,,,
Horas planificadas VS Registradas,,,,,,,
COLABORADOR, HORAS TOTALES,HORAS PLANEADAS,HORAS ADICIONALES,70%,HORAS EXTRAS,COMPENSACIÓN,TOTAL
GIUBASSO JIMENEZ MARIANGELA FRANCHESCA,23.5,16,7.5,5.25,4.8,16.45,21.25
LINARES VIÑA ALEXANDRA,46.5,16,30.5,21.35,4.8,32.55,37.35
HERRERA CALERO CARLOS DANIEL,47,16,31,21.7,4.8,32.9,37.7
YZQUIERDO TAPIA KEVIN ALEXANDER,42,16,26,18.2,4.8,29.4,34.2
QUISPE APON OMAR GABRIEL ANDRE,41,16,25,17.5,4.8,28.7,33.5
TAPARA ALDANA ROBERTO ARMANDO,41.5,16,25.5,17.85,4.8,29.05,33.85
VILLAVICENCIO RAMOS DANIEL EDUARDO,39.2,16,23.2,16.24,4.8,27.44,32.24
CARRASCO CUNYA ANTONY STHIF,36.5,16,20.5,14.35,4.8,25.55,30.35
JULCA GONZALES JULIO CÉSAR,41.5,16,25.5,17.85,4.8,29.05,33.85
PADILLA AVALOS DIOGO ARMANDO,18,16,2,1.4,4.8,7.4,12.2
CONDORI CONDORI ROXANA,30.7,16,14.7,10.29,4.8,21.29,26.09
REVILLA OCHOA JEISOM JAVIER,5.5,6,-0.5,-0.35,4.8,4.3,9.1
`;

        /**
         * Estructura para almacenar los datos diarios y de resumen.
         * @typedef {Object} ParsedData
         * @property {Array<Object>} daily - Datos de horas por día.
         * @property {Array<Object>} summary - Datos de resumen (total, planeado, desviación, 70%, horas extras, compensación, total).
         */

        /**
         * Analiza el contenido del CSV para extraer los datos diarios y de resumen.
         * @param {string} csvText - El contenido completo del CSV.
         * @returns {ParsedData} Un objeto con los datos diarios y de resumen.
         */
        function parseData(csvText) {
            const lines = csvText.trim().split('\n');
            const dailyData = [];
            const summaryData = [];
            
            // --- 1. Sección de Horas Diarias (Inicio del archivo) ---
            let dailyEndLine = lines.findIndex(line => line.includes('Horas planificadas VS Registradas'));

            if (lines.length > 0) {
                // Las filas de datos comienzan en la línea 1 (índice 1)
                for (let i = 1; i < dailyEndLine; i++) {
                    const line = lines[i].trim();
                    if (line === '' || line.match(/^,*$/) || line.includes('Horas planificadas')) break;
                    
                    const parts = line.split(',').map(p => p.trim());
                    if (parts.length >= 4 && !isNaN(parseFloat(parts[4]))) {
                        dailyData.push({
                            colaborador: parts[0],
                            dia1: parseFloat(parts[1]) || 0, 
                            dia2: parseFloat(parts[2]) || 0, 
                            dia3: parseFloat(parts[3]) || 0, 
                            total: parseFloat(parts[4]) || 0,
                        });
                    }
                }
            }


            // --- 2. Sección de Horas de Resumen (Desviación y Compensación) ---
            const targetHeader = 'COLABORADOR, HORAS TOTALES,HORAS PLANEADAS,HORAS ADICIONALES,70%,HORAS EXTRAS,COMPENSACIÓN,TOTAL';
            let startParsingSummary = false;

            for (const line of lines) {
                const trimmedLine = line.trim();

                if (trimmedLine.includes(targetHeader)) {
                    startParsingSummary = true;
                    continue; // Saltar la línea del encabezado
                }

                if (startParsingSummary) {
                    if (trimmedLine === '' || trimmedLine.match(/^,*$/)) {
                        break;
                    }

                    const parts = trimmedLine.split(',').map(p => p.trim());
                    
                    // Asegurarse de que haya suficientes partes para el nuevo formato
                    if (parts.length >= 8) {
                        const colaborador = parts[0];
                        // Convertir a float. Usamos 0 si la conversión falla.
                        const totalHoras = parseFloat(parts[1]) || 0;
                        const planeadas = parseFloat(parts[2]) || 0;
                        const adicionales = parseFloat(parts[3]) || 0;
                        const p70 = parseFloat(parts[4]) || 0;
                        const extras = parseFloat(parts[5]) || 0;
                        const compensacion = parseFloat(parts[6]) || 0;
                        const total = parseFloat(parts[7]) || 0;


                        if (colaborador) {
                            summaryData.push({
                                colaborador: colaborador,
                                totalHoras: totalHoras,
                                horasPlaneadas: planeadas,
                                horasAdicionales: adicionales,
                                p70: p70,
                                horasExtras: extras,
                                compensacion: compensacion,
                                total: total
                            });
                        }
                    }
                }
            }
            return { daily: dailyData, summary: summaryData };
        }

        /**
         * Renderiza la tabla de horas diarias con el total de columna.
         * @param {Array<Object>} dailyData - Los datos de horas por día.
         */
        function renderDailyTable(dailyData) {
            const tableBody = document.getElementById('dailyTableBody');
            const tableFooter = document.getElementById('dailyTableFooter');
            tableBody.innerHTML = ''; 
            tableFooter.innerHTML = '';

            let totalDia1 = 0;
            let totalDia2 = 0;
            let totalDia3 = 0;
            let totalGeneral = 0;

            dailyData.forEach(item => {
                totalDia1 += item.dia1;
                totalDia2 += item.dia2;
                totalDia3 += item.dia3;
                totalGeneral += item.total;

                const row = document.createElement('tr');
                row.classList.add('hover:bg-blue-50', 'transition-colors');
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 text-left">${item.colaborador}</td>
                    <td class="table-data text-gray-700">${item.dia1.toFixed(1)} h</td>
                    <td class="table-data text-gray-700">${item.dia2.toFixed(1)} h</td>
                    <td class="table-data text-gray-700">${item.dia3.toFixed(1)} h</td>
                    <td class="table-data text-gray-900 font-semibold">${item.total.toFixed(1)} h</td>
                `;
                tableBody.appendChild(row);
            });

            // Fila de Total
            const totalRow = document.createElement('tr');
            totalRow.classList.add('total-row');
            totalRow.innerHTML = `
                <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-gray-900 text-left">TOTALES GENERALES</td>
                <td class="table-data font-bold text-gray-900">${totalDia1.toFixed(1)} h</td>
                <td class="table-data font-bold text-gray-900">${totalDia2.toFixed(1)} h</td>
                <td class="table-data font-bold text-gray-900">${totalDia3.toFixed(1)} h</td>
                <td class="table-data font-bold text-blue-800">${totalGeneral.toFixed(1)} h</td>
            `;
            tableFooter.appendChild(totalRow);
        }
        

        /**
         * Renderiza la tabla de resumen (desviación y compensación) con el total de columna.
         * @param {Array<Object>} summaryData - Los datos de resumen.
         */
        function renderSummaryTable(summaryData) {
            const tableBody = document.getElementById('summaryTableBody');
            const tableFooter = document.getElementById('summaryTableFooter');
            tableBody.innerHTML = ''; 
            tableFooter.innerHTML = '';

            let totalHoras = 0;
            let totalPlaneadas = 0;
            let totalAdicionales = 0;
            let totalP70 = 0;
            let totalExtras = 0;
            let totalCompensacion = 0;
            let totalFinal = 0; // El nuevo total final

            summaryData.forEach(item => {
                totalHoras += item.totalHoras;
                totalPlaneadas += item.horasPlaneadas;
                totalAdicionales += item.horasAdicionales;
                totalP70 += item.p70;
                totalExtras += item.horasExtras;
                totalCompensacion += item.compensacion;
                totalFinal += item.total; // Sumar el nuevo campo 'total'

                // Definir color de texto para las horas adicionales (rojo para positivo, verde para negativo)
                const deviationClass = item.horasAdicionales > 0 
                    ? 'text-red-600 font-semibold' 
                    : item.horasAdicionales < 0 
                        ? 'text-green-600 font-semibold' 
                        : 'text-gray-600';

                const row = document.createElement('tr');
                row.classList.add('hover:bg-blue-50', 'transition-colors');
                row.innerHTML = `
                    <td class="table-data text-left font-medium text-gray-900">${item.colaborador}</td>
                    <td class="table-data text-gray-700">${item.totalHoras.toFixed(1)} h</td>
                    <td class="table-data text-gray-700">${item.horasPlaneadas.toFixed(1)} h</td>
                    <td class="table-data ${deviationClass}">${item.horasAdicionales.toFixed(1)} h</td>
                    <td class="table-data text-gray-700">${item.p70.toFixed(2)} h</td>
                    <td class="table-data text-gray-700">${item.horasExtras.toFixed(2)} h</td>
                    <td class="table-data text-gray-700">${item.compensacion.toFixed(2)} h</td>
                    <td class="table-data final-total">${item.total.toFixed(2)} h</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Fila de Total de Resumen
            const totalDeviationClass = totalAdicionales > 0 ? 'text-red-800' : totalAdicionales < 0 ? 'text-green-800' : 'text-gray-800';

            const totalRow = document.createElement('tr');
            totalRow.classList.add('deviation-row');
            totalRow.innerHTML = `
                <td class="table-data text-left font-bold text-gray-900">TOTALES DE PROYECTO</td>
                <td class="table-data font-bold text-gray-900">${totalHoras.toFixed(1)} h</td>
                <td class="table-data font-bold text-gray-900">${totalPlaneadas.toFixed(1)} h</td>
                <td class="table-data font-bold ${totalDeviationClass}">${totalAdicionales.toFixed(1)} h</td>
                <td class="table-data font-bold text-gray-900">${totalP70.toFixed(2)} h</td>
                <td class="table-data font-bold text-gray-900">${totalExtras.toFixed(2)} h</td>
                <td class="table-data font-bold text-gray-900">${totalCompensacion.toFixed(2)} h</td>
                <td class="table-data font-bold text-blue-900 final-total">${totalFinal.toFixed(2)} h</td>
            `;
            tableFooter.appendChild(totalRow);
        }

        /**
         * Renderiza los dos gráficos usando Chart.js.
         * @param {Array<Object>} data - Los datos de los colaboradores.
         */
        function renderCharts(data) {
            const labels = data.map(item => item.colaborador.split(' ')[0]); // Usar solo el primer nombre
            const totalHours = data.map(item => item.totalHoras);
            const additionalHours = data.map(item => item.horasAdicionales);

            // --- Gráfico 1: Horas Totales Registradas ---
            // Destruir gráfico existente si existe
            if (window.totalHoursChartInstance) { window.totalHoursChartInstance.destroy(); }
            window.totalHoursChartInstance = new Chart(document.getElementById('totalHoursChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas Totales (h)',
                        data: totalHours,
                        backgroundColor: '#3b82f6', // blue-500
                        borderColor: '#2563eb', // blue-600
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Horas'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.formattedValue + ' h';
                                }
                            }
                        }
                    }
                }
            });

            // --- Gráfico 2: Horas Adicionales (Desviación) ---
            // Destruir gráfico existente si existe
            if (window.additionalHoursChartInstance) { window.additionalHoursChartInstance.destroy(); }
            window.additionalHoursChartInstance = new Chart(document.getElementById('additionalHoursChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Horas Adicionales (h)',
                        data: additionalHours,
                        // Colores condicionales: Rojo para desviación positiva (más horas), Azul/Verde para desviación negativa (menos horas)
                        backgroundColor: additionalHours.map(h => h > 0 ? '#ef4444' : '#10b981'), // red-500 o emerald-500
                        borderColor: additionalHours.map(h => h > 0 ? '#dc2626' : '#059669'), // red-600 o emerald-600
                        borderWidth: 1,
                        borderRadius: 4,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'Desviación (Horas)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + context.formattedValue + ' h';
                                },
                                title: function(context) {
                                    const fullCollaboratorName = data[context[0].dataIndex].colaborador;
                                    return fullCollaboratorName;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Inicialización del Dashboard ---
        window.onload = function() {
            try {
                const parsedData = parseData(csvData);
                if (parsedData.daily.length > 0 && parsedData.summary.length > 0) {
                    renderDailyTable(parsedData.daily);
                    renderSummaryTable(parsedData.summary);
                    renderCharts(parsedData.summary);
                } else {
                    document.getElementById('app').innerHTML = '<p class="text-center text-red-500 text-lg p-10">No se pudieron extraer datos válidos del CSV para el dashboard.</p>';
                }
            } catch (error) {
                console.error("Error al inicializar el dashboard:", error);
                document.getElementById('app').innerHTML = '<p class="text-center text-red-500 text-lg p-10">Ocurrió un error al procesar los datos.</p>';
            }
        };

    </script>
</body>
</html>
